import numpy as np
from scipy.interpolate import PchipInterpolator
import csv

# ============================================================
# 1. Previous year's aggregate-to-ATAR data (from user)
# ============================================================
prev_data = [
    (488.62, 99.95), (487.96, 99.93), (487.58, 99.87), (487.50, 99.85),
    (486.54, 99.70), (486.50, 99.69), (485.55, 99.54), (484.84, 99.43),
    (484.51, 99.37), (484.38, 99.35), (483.90, 99.28), (483.53, 99.22),
    (483.24, 99.17), (482.86, 99.11), (482.77, 99.10), (482.62, 99.07),
    (482.34, 99.03), (482.25, 99.01), (481.43, 98.88), (481.26, 98.85),
    (481.06, 98.82), (480.90, 98.79), (480.82, 98.78), (480.74, 98.77),
    (479.58, 98.58), (479.36, 98.55), (479.30, 98.54), (479.06, 98.50),
    (478.69, 98.44), (478.30, 98.37), (477.65, 98.27), (477.59, 98.26),
    (477.08, 98.18), (476.96, 98.16), (476.80, 98.13), (476.65, 98.11),
    (476.36, 98.06), (476.19, 98.03), (475.18, 97.87), (475.12, 97.86),
    (475.00, 97.84), (474.89, 97.82), (474.72, 97.79), (474.66, 97.78),
    (474.55, 97.76), (474.50, 97.75), (474.24, 97.71), (474.14, 97.69),
    (474.06, 97.68), (473.94, 97.66), (473.88, 97.65), (473.73, 97.63),
    (473.71, 97.62), (473.60, 97.61), (473.58, 97.60), (473.30, 97.56),
    (472.75, 97.47), (472.51, 97.43), (472.45, 97.42), (472.44, 97.41),
    (472.09, 97.36), (471.91, 97.33), (471.70, 97.29), (471.49, 97.26),
    (470.64, 97.12), (470.32, 97.06), (470.14, 97.03), (470.07, 97.02),
    (470.01, 97.01), (469.30, 96.89), (469.01, 96.84), (468.83, 96.81),
    (468.67, 96.79), (467.86, 96.65), (467.66, 96.62), (467.50, 96.59),
    (467.35, 96.56), (467.12, 96.53), (466.94, 96.49), (466.85, 96.48),
    (466.41, 96.41), (466.34, 96.39), (466.27, 96.38), (466.22, 96.37),
    (465.55, 96.26), (465.47, 96.25), (465.44, 96.24), (464.98, 96.16),
    (464.71, 96.12), (464.66, 96.11), (464.64, 96.10), (464.41, 96.06),
    (464.11, 96.01), (463.96, 95.99), (463.03, 95.83), (462.45, 95.73),
    (462.38, 95.72), (462.04, 95.66), (461.95, 95.64), (461.85, 95.63),
    (461.82, 95.62), (461.72, 95.60), (461.51, 95.57), (461.32, 95.53),
    (461.26, 95.52), (461.17, 95.51), (460.70, 95.43), (460.62, 95.41),
    (460.21, 95.34), (460.03, 95.31), (459.82, 95.27), (459.39, 95.20),
    (458.85, 95.11), (458.71, 95.08), (458.59, 95.06), (457.62, 94.89),
    (457.53, 94.87), (457.27, 94.83), (457.14, 94.81), (456.64, 94.72),
    (456.46, 94.69), (455.81, 94.57), (455.62, 94.54), (455.54, 94.53),
    (455.09, 94.45), (454.75, 94.39), (454.58, 94.36), (454.35, 94.32),
    (454.18, 94.29), (454.16, 94.28), (454.08, 94.27), (453.84, 94.23),
    (453.63, 94.19), (453.10, 94.09), (453.04, 94.08), (452.71, 94.03),
    (452.37, 93.97), (452.05, 93.91), (451.53, 93.82), (451.12, 93.74),
    (450.95, 93.71), (450.10, 93.56), (449.65, 93.48), (449.29, 93.42),
    (449.19, 93.40), (448.94, 93.36), (448.78, 93.33), (448.28, 93.24),
    (448.22, 93.23), (448.00, 93.19), (447.73, 93.14), (447.43, 93.09),
    (447.29, 93.06), (446.88, 92.99), (446.65, 92.95), (446.14, 92.86),
    (446.03, 92.84), (445.99, 92.83), (445.53, 92.75), (445.48, 92.74),
    (445.23, 92.69), (444.96, 92.65), (444.71, 92.60), (444.31, 92.53),
    (443.81, 92.44), (443.61, 92.41), (442.91, 92.28), (442.74, 92.25),
    (442.10, 92.14), (441.28, 91.99), (441.12, 91.96), (440.19, 91.79),
    (440.03, 91.77), (439.97, 91.75), (438.18, 91.44), (438.06, 91.41),
    (437.62, 91.34), (437.00, 91.22), (436.88, 91.20), (436.10, 91.06),
    (435.92, 91.03), (435.53, 90.96), (435.43, 90.95), (435.08, 90.88),
    (434.76, 90.83), (433.41, 90.59), (432.80, 90.48), (432.28, 90.38),
    (431.99, 90.33), (431.62, 90.27), (430.53, 90.07), (430.11, 90.00),
    (429.88, 89.96), (429.68, 89.92), (429.50, 89.89), (429.07, 89.81),
    (428.95, 89.79), (428.14, 89.65), (427.36, 89.51), (425.99, 89.27),
    (425.81, 89.24), (425.12, 89.11), (424.95, 89.08), (424.19, 88.95),
    (424.06, 88.93), (424.02, 88.92), (423.66, 88.85), (423.19, 88.77),
    (423.10, 88.76), (422.93, 88.73), (422.85, 88.71), (422.33, 88.62),
    (421.96, 88.55), (421.69, 88.51), (421.51, 88.47), (421.36, 88.45),
    (421.23, 88.42), (420.67, 88.33), (420.04, 88.21), (419.23, 88.07),
    (418.23, 87.89), (417.97, 87.85), (417.88, 87.83), (416.77, 87.64),
    (416.76, 87.63), (415.47, 87.41), (415.23, 87.36), (414.78, 87.28),
    (414.54, 87.24), (413.89, 87.13), (412.50, 86.88), (412.23, 86.83),
    (411.98, 86.79), (411.37, 86.68), (411.00, 86.61), (410.83, 86.58),
    (410.50, 86.53), (410.42, 86.51), (408.64, 86.20), (408.28, 86.13),
    (407.84, 86.05), (404.78, 85.51), (404.63, 85.48), (402.64, 85.13),
    (402.26, 85.06), (401.88, 84.99), (401.62, 84.95), (401.51, 84.93),
    (401.22, 84.88), (401.12, 84.86), (400.65, 84.78), (400.12, 84.68),
    (399.88, 84.64), (398.27, 84.35), (397.76, 84.26), (397.46, 84.21),
    (396.81, 84.09), (396.36, 84.01), (395.87, 83.92), (395.07, 83.78),
    (394.71, 83.72), (394.55, 83.69), (394.45, 83.67), (394.22, 83.63),
    (393.09, 83.43), (392.25, 83.28), (392.00, 83.23), (391.69, 83.18),
    (389.29, 82.75), (388.42, 82.59), (387.63, 82.45), (387.47, 82.42),
    (387.27, 82.39), (384.89, 81.96), (384.65, 81.92), (382.67, 81.56),
    (381.69, 81.39), (380.81, 81.23), (380.68, 81.21), (379.96, 81.08),
    (379.81, 81.05), (378.53, 80.83), (375.44, 80.28), (373.51, 79.93),
    (373.23, 79.88), (370.81, 79.45), (370.69, 79.43), (370.28, 79.36),
    (369.69, 79.25), (369.17, 79.16), (368.75, 79.08), (367.12, 78.79),
    (366.95, 78.76), (366.48, 78.68), (365.30, 78.47), (362.49, 77.96),
    (362.29, 77.93), (361.85, 77.85), (359.97, 77.51), (358.11, 77.18),
    (357.58, 77.08), (356.47, 76.88), (355.37, 76.68), (354.77, 76.57),
    (353.46, 76.34), (351.94, 76.06), (350.80, 75.85), (349.22, 75.56),
    (349.08, 75.53), (348.26, 75.38), (348.21, 75.37), (347.72, 75.28),
    (346.48, 75.05), (346.42, 75.04), (346.04, 74.97), (345.16, 74.81),
    (344.40, 74.67), (343.63, 74.52), (343.22, 74.44), (343.17, 74.43),
    (338.29, 73.51), (338.08, 73.47), (336.99, 73.26), (336.63, 73.19),
    (336.29, 73.12), (336.10, 73.08), (335.81, 73.03), (334.00, 72.67),
    (331.84, 72.25), (330.69, 72.02), (329.75, 71.84), (329.23, 71.73),
    (328.31, 71.55), (328.14, 71.51), (327.51, 71.39), (327.20, 71.33),
    (326.35, 71.15), (326.08, 71.10), (325.82, 71.05), (325.38, 70.96),
    (321.38, 70.14), (319.44, 69.74), (318.84, 69.61), (318.70, 69.58),
    (318.51, 69.54), (311.43, 68.05), (311.22, 68.01), (308.77, 67.48),
    (308.04, 67.33), (306.55, 67.00), (306.19, 66.93), (305.78, 66.84),
    (305.57, 66.79), (302.07, 66.03), (301.24, 65.84), (300.57, 65.70),
    (298.67, 65.28), (298.47, 65.23), (295.89, 64.66), (293.63, 64.15),
    (292.74, 63.95), (290.71, 63.49), (290.02, 63.33), (289.74, 63.27),
    (289.40, 63.19), (287.90, 62.85), (286.82, 62.60), (286.59, 62.54),
    (286.50, 62.52), (285.86, 62.38), (285.56, 62.31), (285.28, 62.24),
    (285.01, 62.18), (283.92, 61.92), (282.32, 61.55), (282.05, 61.48),
    (280.17, 61.04), (279.40, 60.85), (279.11, 60.78), (277.49, 60.40),
    (273.55, 59.43), (273.51, 59.42), (273.46, 59.41), (270.85, 58.76),
    (270.30, 58.62), (270.17, 58.59), (264.50, 57.13), (264.08, 57.02),
    (259.78, 55.88), (258.13, 55.43), (257.76, 55.33), (250.09, 53.18),
    (245.22, 51.77), (242.43, 50.95), (237.17, 49.37), (235.47, 48.85),
    (232.36, 47.89), (231.93, 47.76), (228.27, 46.62), (223.24, 45.04),
    (222.70, 44.87), (220.12, 44.05), (212.20, 41.53), (209.34, 40.62),
    (203.98, 38.91), (199.44, 37.46),
]

prev_agg = np.array([x[0] for x in prev_data])
prev_atar = np.array([x[1] for x in prev_data])

# ============================================================
# 2. 2025 ATAR distribution from report
# ============================================================
# Table 13: individual bands 98.00-99.95
table13 = [
    (99.95, 37), (99.90, 37), (99.85, 38), (99.80, 37), (99.75, 37),
    (99.70, 38), (99.65, 37), (99.60, 37), (99.55, 38), (99.50, 37),
    (99.45, 38), (99.40, 37), (99.35, 38), (99.30, 39), (99.25, 38),
    (99.20, 37), (99.15, 38), (99.10, 37), (99.05, 38), (99.00, 38),
    (98.95, 37), (98.90, 38), (98.85, 38), (98.80, 38), (98.75, 38),
    (98.70, 37), (98.65, 37), (98.60, 39), (98.55, 37), (98.50, 38),
    (98.45, 38), (98.40, 37), (98.35, 38), (98.30, 37), (98.25, 37),
    (98.20, 38), (98.15, 38), (98.10, 38), (98.05, 38), (98.00, 39),
]

# Table 14: 20-band (1-point) groups with total students
table14 = [
    ("99.00-99.95", 751), ("98.00-98.95", 755), ("97.00-97.95", 756),
    ("96.00-96.95", 761), ("95.00-95.95", 754), ("94.00-94.95", 752),
    ("93.00-93.95", 754), ("92.00-92.95", 753), ("91.00-91.95", 751),
    ("90.00-90.95", 748), ("89.00-89.95", 746), ("88.00-88.95", 739),
    ("87.00-87.95", 735), ("86.00-86.95", 732), ("85.00-85.95", 732),
    ("84.00-84.95", 724), ("83.00-83.95", 714), ("82.00-82.95", 708),
    ("81.00-81.95", 699), ("80.00-80.95", 694), ("79.00-79.95", 678),
    ("78.00-78.95", 669), ("77.00-77.95", 655), ("76.00-76.95", 643),
    ("75.00-75.95", 628), ("74.00-74.95", 614), ("73.00-73.95", 596),
    ("72.00-72.95", 578), ("71.00-71.95", 561), ("70.00-70.95", 540),
    ("69.00-69.95", 518), ("68.00-68.95", 495), ("67.00-67.95", 475),
    ("66.00-66.95", 453), ("65.00-65.95", 432), ("64.00-64.95", 413),
    ("63.00-63.95", 396), ("62.00-62.95", 375), ("61.00-61.95", 359),
    ("60.00-60.95", 342), ("59.00-59.95", 326), ("58.00-58.95", 308),
    ("57.00-57.95", 292), ("56.00-56.95", 278), ("55.00-55.95", 263),
    ("54.00-54.95", 250), ("53.00-53.95", 238), ("52.00-52.95", 222),
    ("51.00-51.95", 210), ("50.00-50.95", 199), ("49.00-49.95", 186),
    ("48.00-48.95", 177), ("47.00-47.95", 166), ("46.00-46.95", 157),
    ("45.00-45.95", 145), ("44.00-44.95", 135), ("43.00-43.95", 128),
    ("42.00-42.95", 118), ("41.00-41.95", 111), ("40.00-40.95", 104),
    ("39.00-39.95", 96), ("38.00-38.95", 89), ("37.00-37.95", 81),
    ("36.00-36.95", 76), ("35.00-35.95", 69), ("34.00-34.95", 64),
    ("33.00-33.95", 59), ("32.00-32.95", 53), ("31.00-31.95", 48),
    ("30.05-30.95", 43),
]

TOTAL_STUDENTS = 30167
BELOW_30_STUDENTS = 298

# ============================================================
# 3. Build cumulative distribution for every 0.05 ATAR band
# ============================================================
# For bands 98.00-99.95, we have exact counts from Table 13
# For bands 30.05-97.95, distribute each 1-point group across 20 bands

# Create dict of band -> number of students from Table 13
band_students = {}
for atar, count in table13:
    band_students[round(atar, 2)] = count

# For Table 14 ranges not covered by Table 13, distribute evenly
for range_str, total_count in table14:
    parts = range_str.split("-")
    low = float(parts[0])
    high = float(parts[1])

    # Generate all 0.05 bands in this range
    bands_in_range = []
    b = high
    while b >= low - 0.001:
        br = round(b, 2)
        bands_in_range.append(br)
        b -= 0.05

    # Check which are already assigned from Table 13
    already_assigned = sum(band_students.get(br, 0) for br in bands_in_range if br in band_students)
    unassigned = [br for br in bands_in_range if br not in band_students]

    remaining = total_count - already_assigned
    if remaining <= 0 or len(unassigned) == 0:
        continue

    # Distribute remaining students across unassigned bands
    n = len(unassigned)
    base = remaining // n
    extra = remaining - base * n

    # Give the extra students to the higher bands
    unassigned_sorted = sorted(unassigned, reverse=True)
    for i, br in enumerate(unassigned_sorted):
        band_students[br] = base + (1 if i < extra else 0)

# ============================================================
# 4. Build cumulative distribution
# ============================================================
sorted_bands = sorted(band_students.keys(), reverse=True)
cumulative = {}
running_total = 0
for band in sorted_bands:
    running_total += band_students[band]
    cumulative[band] = running_total

print(f"Total students in bands 30.05-99.95: {running_total}")
print(f"Expected: 29,869")
print(f"Plus 298 below 30 = {running_total + 298}")

# ============================================================
# 5. Fit aggregate-to-ATAR model from previous year's data
# ============================================================
# Sort by ATAR ascending
sort_idx = np.argsort(prev_atar)
prev_atar_sorted = prev_atar[sort_idx]
prev_agg_sorted = prev_agg[sort_idx]

# Remove duplicate ATAR values (keep average aggregate)
unique_atars = []
unique_aggs = []
i = 0
while i < len(prev_atar_sorted):
    j = i
    while j < len(prev_atar_sorted) and prev_atar_sorted[j] == prev_atar_sorted[i]:
        j += 1
    unique_atars.append(prev_atar_sorted[i])
    unique_aggs.append(np.mean(prev_agg_sorted[i:j]))
    i = j

unique_atars = np.array(unique_atars)
unique_aggs = np.array(unique_aggs)

# Fit PCHIP interpolation: ATAR -> Aggregate
interp_atar_to_agg = PchipInterpolator(unique_atars, unique_aggs)

# ============================================================
# 6. Generate the lookup table
# ============================================================
print(f"\n{'ATAR':>8} | {'Aggregate':>10} | {'Students':>8} | {'Cumulative':>10} | {'Cum %':>8}")
print("-" * 55)

results = []
for band in sorted_bands:
    atar = band

    if atar <= unique_atars[-1] and atar >= unique_atars[0]:
        agg = float(interp_atar_to_agg(atar))
    elif atar > unique_atars[-1]:
        slope = float(interp_atar_to_agg.derivative()(unique_atars[-1]))
        agg = float(unique_aggs[-1]) + slope * (atar - unique_atars[-1])
        agg = min(agg, 500.0)
    else:
        slope = float(interp_atar_to_agg.derivative()(unique_atars[0]))
        agg = float(unique_aggs[0]) + slope * (atar - unique_atars[0])
        agg = max(agg, 0.0)

    n_students = band_students[band]
    cum_students = cumulative[band]
    cum_pct = cum_students / TOTAL_STUDENTS * 100

    results.append((atar, round(agg, 2), n_students, cum_students, round(cum_pct, 2)))

# Print selected rows
key_atars = {99.95, 99.90, 99.85, 99.80, 99.75, 99.70, 99.65, 99.60, 99.55, 99.50,
             99.00, 98.50, 98.00, 97.50, 97.00, 96.50, 96.00, 95.50, 95.00,
             94.00, 93.00, 92.00, 91.00, 90.00, 89.00, 88.00, 87.00, 86.00,
             85.00, 84.00, 83.00, 82.00, 81.00, 80.00, 79.00, 78.00, 77.00,
             76.00, 75.00, 74.00, 73.00, 72.00, 71.00, 70.00, 65.00, 60.00,
             55.00, 50.00, 45.00, 40.00, 35.00, 30.05}
for row in results:
    if row[0] in key_atars:
        print(f"{row[0]:8.2f} | {row[1]:10.2f} | {row[2]:8d} | {row[3]:10,d} | {row[4]:7.2f}%")

# ============================================================
# 7. Save full lookup table to CSV
# ============================================================
csv_path = "C:/PSAM/QLD/atar scaling/aggregate_to_atar_2025.csv"
with open(csv_path, 'w', newline='') as f:
    writer = csv.writer(f)
    writer.writerow(['ATAR', 'Aggregate', 'Students_in_Band', 'Cumulative_Students', 'Cumulative_Pct'])
    for row in results:
        writer.writerow(row)

print(f"\nFull lookup table saved to: {csv_path}")
print(f"Total bands: {len(results)}")

# Save simplified two-column lookup (Aggregate -> ATAR), sorted by aggregate descending
csv_path2 = "C:/PSAM/QLD/atar scaling/aggregate_atar_lookup_2025.csv"
with open(csv_path2, 'w', newline='') as f:
    writer = csv.writer(f)
    writer.writerow(['Aggregate', 'ATAR'])
    for row in sorted(results, key=lambda x: x[1], reverse=True):
        writer.writerow([row[1], row[0]])

print(f"Simplified lookup saved to: {csv_path2}")

# Validation: compare a few points against previous year
print("\n=== VALIDATION: 2025 vs Previous Year ===")
print(f"{'ATAR':>8} | {'2025 Agg':>10} | {'Prev Agg':>10} | {'Diff':>8}")
print("-" * 45)
check_atars = [99.95, 99.00, 98.00, 97.00, 95.00, 93.00, 90.00, 85.00, 80.00, 75.00, 70.00, 60.00, 50.00, 40.00]
result_dict = {r[0]: r[1] for r in results}
prev_dict = dict(zip(unique_atars, unique_aggs))
for a in check_atars:
    new_val = result_dict.get(a, None)
    if new_val and a >= unique_atars[0] and a <= unique_atars[-1]:
        old_val = float(interp_atar_to_agg(a))
        print(f"{a:8.2f} | {new_val:10.2f} | {old_val:10.2f} | {new_val - old_val:+8.2f}")
